# Tutorial Chapter 1 - Cooked Hancho, or how to use ```{templates}``` to make generic build tasks.

## ```tut10.hancho```: Factoring out the build directory

Let's take a look at the tasks in ```tut02.hancho``` again:

https://github.com/aappleby/hancho/blob/29ee9c997102fe3c361b9a3a7249cfa43ca1693d/tutorial/tut02.hancho#L12-L33

We have to specify the build directory ```build/tut02``` _ten_ times. Let's move it into the config object:

https://github.com/aappleby/hancho/blob/29ee9c997102fe3c361b9a3a7249cfa43ca1693d/tutorial/tut10.hancho#L5-L11

Now we can use it in our tasks along with the other ```config``` fields to un-hardcode our compile task:

https://github.com/aappleby/hancho/blob/29ee9c997102fe3c361b9a3a7249cfa43ca1693d/tutorial/tut10.hancho#L13-L19

And the link task works the same way:

https://github.com/aappleby/hancho/blob/29ee9c997102fe3c361b9a3a7249cfa43ca1693d/tutorial/tut10.hancho#L29-L34

Note that these strings are _not_ Python f-strings since they don't have the
```f""``` prefix. They are now Hancho template strings, which are similar to f-strings except they're not
evaluated immediately. They do have some drawbacks, however:

- Hancho templates can _only_ refer to fields in a ```Config``` object.
  - If you want to use ```print()``` in a template, you have to pass it in via ```Config(print = print)```.
- List comprehensions usually won't work right unless the left-hand side is strictly of the form ```[x for x in...``` 
  - TL;DR: Python3 wraps list comprehensions in a scope that prevents additional ```Config``` field references and template expansions in the ```[x for x in...``` part.
  - This is a limitation deep inside the Python3 interpreter that has no good workaround.

And some plus sides that f-strings don't have:
- Templates aren't evaluated until immediately before a task runs, which allows them to include expressions that we may not know the value of beforehand
  - For example, the name of a temporary file generated by another task. 
- Hancho templates that refer to ```list```s will get flattened out and joined with spaces
  - Expanding ```"{foo}"``` with ```foo = ["Hello", "Hancho", "World"]``` will produce ```"Hello Hancho World"```
  - Expanding ```"{foo}"``` with ```foo = [[["nesting"]], ["levels"], "don't", [[[[[["matter"]]]]]]]``` will produce ```"nesting levels don't matter"```
- Hancho templates that refer to ```Task```s will be replaced with that task's ```build_files``` converted to absolute paths.
  - In the link task, ```source_files = [main_o, util_o]``` becomes ```["/home/user/hancho/tutorial/build/tut10/src/main.o", "/home/user/hancho/tutorial/build/tut10/src/util.o"]```
- Templates can refer to other templates
  - ```command``` contains ```{build_files}```, ```build_files``` contains ```{build_dir}```, and this all works fine.
- You can nest templates up to ```MAX_EXPAND_DEPTH = 20``` levels deep
  - Probably don't make your templates that complicated, though.
  - Infinite loops like ```Task(command = "lol {command}")``` will expand to ```"lol lol lol lol lol....``` and eventually fail.
